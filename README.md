# ACCROAD_Subsystems

Oracle データベースと連携し、取引先やオーダー単位での付加価値計算を行う社内向けの分析支援アプリケーションです。
Streamlit を用いた Web アプリケーションとして提供され、直感的な操作で付加価値分析が可能です。

---

## 📦 主な機能

### 1. 付加価値分析
- **月次・客先別サマリー**: 月次・顧客別に集計した付加価値を表示
- **オーダー単位詳細**: オーダーごとの詳細な原価・付加価値情報を表示
- **期間指定**: 開始日・終了日を指定して任意の期間のデータを取得
- **統計情報**: 総売上高、総原価、総付加価値、平均付加価値率をリアルタイム表示

### 2. データエクスポート
- Excel形式でのデータエクスポート機能
- 集計モードに応じた最適なファイル名の自動生成
- 列幅の自動調整で見やすいレポートを生成

### 3. 原価の細分化
付加価値計算では、原価を以下のように細分化して管理します：
- **有償支給費**: 有償で支給される材料費（`M_ITEM.A_FPTYPE = 'Y'`）
- **仕入材料費**: 自給素材費（`PROCESS IN ('GEN','SOZ')`）および購入費
- **外注費**: 外部委託による加工費（`M_ITEM.IMTYP = '2'`）

---

## 🗂️ ディレクトリ構成

```
.
├── main.py                   # トップ画面（リリース履歴表示）
├── pages/
│   └── 付加価値分析.py        # メイン機能：付加価値分析画面
├── db/
│   └── database.py           # データベース接続・クエリ管理
├── sql/
│   ├── value_added.sql       # 付加価値計算用SQLクエリ
│   ├── valueadded_note.md    # 計算ロジックの詳細ドキュメント
│   └── ACC_MASTER_TABLE_DEF.md  # テーブル定義書
├── requirements.txt          # Python依存パッケージ
├── .env.template             # 環境変数テンプレート
├── .gitignore
└── README.md
```

---

## 🚀 セットアップ手順

### 1. リポジトリのクローン

```bash
git clone <repository-url>
cd ACC-Subsystems
```

### 2. 必要ライブラリのインストール

Python 3.8 以上が必要です。仮想環境の使用を推奨します。

```bash
# 仮想環境の作成（推奨）
python -m venv .venv

# 仮想環境の有効化
# Windows:
.venv\Scripts\activate
# macOS/Linux:
source .venv/bin/activate

# 依存パッケージのインストール
pip install -r requirements.txt
```

### 3. 環境変数ファイル `.env` の作成

リポジトリルートに `.env` を作成し、Oracle データベースの接続情報を記入してください。

```env
ORACLE_USER=your_username
ORACLE_PASSWORD=your_password
ORACLE_HOST=your_host
ORACLE_PORT=1521
ORACLE_SERVICE=your_service_name
```

**※ `.env.template` を参考にしてください。**

**⚠️ 重要**: `.env` ファイルは機密情報を含むため、絶対に Git にコミットしないでください（`.gitignore` に登録済み）。

---

## ▶️ 実行方法

```bash
streamlit run main.py
```

ブラウザが自動的に開き、アプリケーションが起動します。
デフォルトでは `http://localhost:8501` でアクセスできます。

### 使い方

1. サイドバーから「**付加価値分析**」を選択
2. **期間選択**: 開始日と終了日を指定
3. **集計モード選択**:
   - ① 月次・客先別サマリー
   - ② 月次・オーダー単位詳細
4. **「🔍 データ取得」ボタン**をクリック
5. データが表示されたら、必要に応じて **Excel エクスポート**

---

## 💡 技術スタック

- **Python 3.8+**
- **Streamlit 1.49.0**: Web UI フレームワーク
- **SQLAlchemy 2.0.40**: データベース ORM
- **oracledb 3.4.0**: Oracle データベース接続
- **pandas 2.2.3**: データ分析・加工
- **openpyxl**: Excel ファイル生成

---

## 📊 データ取得ロジック

付加価値計算では、以下の方針でデータを取得します（`sql/valueadded_note.md` 参照）：

### 受注データの取得方針

| 期間 | データソース | 条件 |
|------|------------|------|
| 過去～当月 | `SHIPORDER` テーブル | 常に SHIPORDER から取得 |
| 翌月以降 | `SHIPORDER` または `MPS` | `M_TRANSACTOR.A_EDIF = 1` なら SHIPORDER、<br>それ以外は MPS から取得 |

### 付加価値の計算式

```
付加価値 = 売価 - 原価

原価 = 有償支給費 + 仕入材料費 + 外注費
```

詳細な計算ロジックは `sql/value_added.sql` および `sql/valueadded_note.md` をご参照ください。

---

## 🕒 リリース履歴

### v0.9.0 (2025/10/30)
- 付加価値分析機能を正式導入
- 月次・客先別サマリー表示機能
- オーダー単位詳細表示機能
- Excel エクスポート機能
- 統計情報のリアルタイム表示

### v0.0.1 (2025/5/7)
- ベータ版として付加価値計算機能の初版リリース

---

## 📌 注意事項

- **社内専用**: このリポジトリは社内用途向けで、外部公開を想定していません。
- **機密情報管理**: `.env` ファイルは絶対に Git に含めないでください。
- **データベース接続**: Oracle データベースへの接続権限が必要です。
- **ネットワーク**: 社内ネットワークまたは VPN 接続が必要な場合があります。

---

## 🐛 トラブルシューティング

### データベース接続エラー
- `.env` ファイルの設定を確認してください
- Oracle データベースへの接続権限を確認してください
- ネットワーク接続を確認してください

### パッケージインストールエラー
- Python のバージョンが 3.8 以上であることを確認してください
- 仮想環境を使用することを推奨します

### データが取得できない
- 指定期間にデータが存在するか確認してください
- データベース接続が正常か確認してください
- エラーメッセージの詳細を「詳細なエラー情報」で確認してください

---

## 📞 サポート

問題が発生した場合は、社内の担当部署までお問い合わせください。